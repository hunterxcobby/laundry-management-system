# Copilot Rules for Laundry Management System

This document defines coding standards, patterns, and best practices for the Laundry Management System project. Follow these rules to maintain consistency and quality across the codebase.

## 🏗️ Project Architecture Guidelines

### MVC Pattern (CodeIgniter)

- **Controllers**: Handle HTTP requests, user input validation, and coordinate between models and views
- **Models**: Manage database operations, business logic, and data validation
- **Views**: Handle presentation logic only, minimal PHP processing
- **Libraries**: Reusable components for specific functionality (messaging, file handling, etc.)

### File Organization

```
application/
├── controllers/     # One controller per major feature area
├── models/         # Database interaction models
├── views/          # Organized by user role (admin/, customer/, employee/)
├── libraries/      # Custom libraries for business logic
├── helpers/        # Utility functions
└── config/         # Configuration files
```

## 📝 Coding Standards

### PHP Standards

#### General Rules

- Follow PSR-1 and PSR-2 coding standards where applicable
- Use camelCase for method names: `getUserOrders()`, `processPayment()`
- Use PascalCase for class names: `OrderManager`, `CustomerService`
- Use snake_case for database fields: `customer_id`, `order_date`
- Always use opening and closing PHP tags: `<?php` and `?>`

#### CodeIgniter Specific

```php
// ✅ Good - Proper CodeIgniter controller structure
class Admin extends CI_Controller {
    public function __construct() {
        parent::__construct();
        $this->load->database();
        $this->load->model('order_model');
        $this->load->helper(['url', 'form']);
    }
  
    public function customer_orders($action = 'list') {
        // Method implementation
    }
}

// ❌ Bad - Missing structure
class admin {
    function orders() {
        // Direct database queries without models
    }
}
```

#### Database Operations

```php
// ✅ Good - Use Active Record pattern
$this->db->select('id, customer_name, order_date')
         ->from('customer_order')
         ->where('order_status', 'pending')
         ->order_by('order_date', 'DESC');
$orders = $this->db->get()->result();

// ✅ Good - Use prepared statements for dynamic queries
$this->db->where('customer_id', $customer_id);
$this->db->where('order_date >=', $start_date);

// ❌ Bad - Direct SQL with concatenation
$sql = "SELECT * FROM customer_order WHERE customer_id = " . $customer_id;
```

### Security Best Practices

#### Input Validation

```php
// ✅ Good - Always validate and sanitize input
$customer_id = $this->input->post('customer_id');
if (!is_numeric($customer_id)) {
    show_error('Invalid customer ID');
}

$email = $this->input->post('email');
if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
    $this->form_validation->set_message('valid_email', 'Please enter a valid email');
}

// ✅ Good - Use form validation library
$this->form_validation->set_rules('mobile', 'Mobile Number', 'required|exact_length[10]|numeric');
$this->form_validation->set_rules('email', 'Email', 'required|valid_email');
```

#### XSS Protection

```php
// ✅ Good - Escape output
echo html_escape($customer_name);
echo $this->security->xss_clean($user_input);

// ❌ Bad - Direct output
echo $customer_name;
```

#### File Upload Security

```php
// ✅ Good - Secure file upload
$config['upload_path'] = './pickup_photo/';
$config['allowed_types'] = 'jpg|jpeg|png';
$config['max_size'] = 2048; // 2MB
$config['encrypt_name'] = TRUE;

$this->load->library('upload', $config);
if (!$this->upload->do_upload('photo')) {
    $error = $this->upload->display_errors();
}
```

## 🗄️ Database Guidelines

### Table Naming

- Use lowercase with underscores: `customer_order`, `price_list`
- Use descriptive names: `order_temp` for temporary orders
- Avoid abbreviations unless widely understood

### Column Naming

```sql
-- ✅ Good
CREATE TABLE customer_order (
    auto_id INT PRIMARY KEY AUTO_INCREMENT,
    invoice_no VARCHAR(20) NOT NULL,
    customer_id INT NOT NULL,
    order_date DATE NOT NULL,
    delivery_date DATE,
    order_status ENUM('neworder', 'pending', 'wash_ready', 'delivered'),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- ❌ Bad
CREATE TABLE orders (
    id INT PRIMARY KEY,
    custId INT,
    dt DATE,
    stat VARCHAR(10)
);
```

### Query Optimization

```php
// ✅ Good - Use specific columns
$this->db->select('id, invoice_no, customer_id, order_status')
         ->from('customer_order')
         ->where('order_date >=', date('Y-m-d', strtotime('-30 days')));

// ✅ Good - Use joins efficiently
$this->db->select('co.invoice_no, u.first_name, u.last_name')
         ->from('customer_order co')
         ->join('users u', 'co.customer_id = u.id', 'left')
         ->where('co.order_status', 'pending');

// ❌ Bad - Select all columns
$this->db->select('*')->from('customer_order');
```

## 🎯 Feature Development Patterns

### Order Management

```php
// ✅ Good - Order processing pattern
class Order_model extends CI_Model {
    public function create_order($order_data) {
        $this->db->trans_start();
      
        // Generate invoice number
        $invoice_no = $this->generate_invoice_number();
        $order_data['invoice_no'] = $invoice_no;
      
        // Insert main order
        $this->db->insert('customer_order', $order_data);
        $order_id = $this->db->insert_id();
      
        // Generate barcode
        $this->generate_barcode($invoice_no);
      
        // Send notifications
        $this->send_order_confirmation($order_data['customer_id'], $invoice_no);
      
        $this->db->trans_complete();
      
        return $this->db->trans_status() ? $order_id : FALSE;
    }
}
```

### API Response Format

```php
// ✅ Good - Consistent API response structure
public function api_response($status, $message, $data = null) {
    $response = [
        'status' => $status,
        'message' => $message,
        'timestamp' => date('Y-m-d H:i:s')
    ];
  
    if ($data !== null) {
        $response['data'] = $data;
    }
  
    header('Content-Type: application/json');
    echo json_encode($response);
}

// Usage
$this->api_response('success', 'Orders retrieved successfully', $orders);
$this->api_response('error', 'Invalid customer ID');
```

### Error Handling

```php
// ✅ Good - Comprehensive error handling
public function process_payment($order_id, $payment_data) {
    try {
        if (empty($order_id) || !is_numeric($order_id)) {
            throw new InvalidArgumentException('Invalid order ID');
        }
      
        $order = $this->order_model->get_order($order_id);
        if (!$order) {
            throw new Exception('Order not found');
        }
      
        // Process payment logic
        $result = $this->payment_gateway->process($payment_data);
      
        if (!$result['success']) {
            throw new Exception('Payment processing failed: ' . $result['error']);
        }
      
        return $result;
      
    } catch (Exception $e) {
        log_message('error', 'Payment processing error: ' . $e->getMessage());
        return ['success' => false, 'error' => $e->getMessage()];
    }
}
```

## 📱 Mobile API Guidelines

### Endpoint Structure

```php
// ✅ Good - RESTful API structure in Flutter controller
public function customer_orders() {
    $method = $_SERVER['REQUEST_METHOD'];
  
    switch ($method) {
        case 'GET':
            $this->get_customer_orders();
            break;
        case 'POST':
            $this->create_customer_order();
            break;
        case 'PUT':
            $this->update_customer_order();
            break;
        default:
            $this->api_response('error', 'Method not allowed');
    }
}
```

### Authentication

```php
// ✅ Good - Mobile authentication pattern
public function authenticate_mobile_user() {
    $mobile = $this->input->post('mobile');
    $otp = $this->input->post('otp');
  
    if (empty($mobile) || empty($otp)) {
        $this->api_response('error', 'Mobile and OTP required');
        return false;
    }
  
    // Verify OTP
    if ($this->verify_otp($mobile, $otp)) {
        $user_data = $this->user_model->get_user_by_mobile($mobile);
        $this->api_response('success', 'Authentication successful', $user_data);
        return true;
    }
  
    $this->api_response('error', 'Invalid OTP');
    return false;
}
```

## 🎨 Frontend Guidelines

### View Structure

```php
<!-- ✅ Good - Proper view structure -->
<?php $this->load->view('admin/header'); ?>

<div class="main-container">
    <div class="main-content">
        <div class="page-header">
            <h1><?php echo lang('Order Management'); ?></h1>
        </div>
      
        <div class="page-content">
            <!-- Content here -->
        </div>
    </div>
</div>

<?php $this->load->view('admin/footer'); ?>
```

### Language Support

```php
// ✅ Good - Use language helper consistently
echo lang('Customer Name');
echo lang('Order Status');

// ✅ Good - In language files
$lang['Customer Name'] = 'Customer Name';
$lang['Order Status'] = 'Order Status';
$lang['Total Amount'] = 'Total Amount';
```

### JavaScript/jQuery Integration

```javascript
// ✅ Good - Proper AJAX handling
function updateOrderStatus(orderId, status) {
    $.ajax({
        url: base_url + 'admin/update_order_status',
        type: 'POST',
        data: {
            order_id: orderId,
            status: status,
            csrf_token: $('input[name="csrf_token"]').val()
        },
        dataType: 'json',
        success: function(response) {
            if (response.success) {
                toastr.success('Order status updated successfully');
                location.reload();
            } else {
                toastr.error(response.message);
            }
        },
        error: function() {
            toastr.error('An error occurred');
        }
    });
}
```

## 🔧 Configuration Standards

### Environment Configuration

```php
// ✅ Good - Environment-specific settings
if (ENVIRONMENT === 'development') {
    $config['base_url'] = 'http://localhost/laundry/';
    ini_set('display_errors', 1);
} else {
    $config['base_url'] = 'https://prolaundryhub.com/';
    ini_set('display_errors', 0);
}
```

### Database Configuration

```php
// ✅ Good - Secure database configuration
$db['default'] = array(
    'dsn' => '',
    'hostname' => getenv('DB_HOST') ?: 'localhost',
    'username' => getenv('DB_USER') ?: 'default_user',
    'password' => getenv('DB_PASS') ?: 'default_pass',
    'database' => getenv('DB_NAME') ?: 'laundry_db',
    'dbdriver' => 'mysqli',
    'dbprefix' => '',
    'pconnect' => FALSE,
    'db_debug' => (ENVIRONMENT !== 'production'),
    'cache_on' => FALSE,
    'cachedir' => '',
    'char_set' => 'utf8',
    'dbcollat' => 'utf8_general_ci',
    'swap_pre' => '',
    'encrypt' => FALSE,
    'compress' => FALSE,
    'stricton' => FALSE,
    'failover' => array(),
    'save_queries' => TRUE
);
```

## 📊 Performance Guidelines

### Database Performance

```php
// ✅ Good - Efficient queries
// Use indexes on frequently queried columns
$this->db->where('customer_id', $customer_id); // Index on customer_id
$this->db->where('order_date >=', $start_date); // Index on order_date

// ✅ Good - Limit results
$this->db->limit(20, $offset);

// ✅ Good - Use appropriate joins
$this->db->join('users', 'users.id = customer_order.customer_id', 'left');
```

### Caching Strategy

```php
// ✅ Good - Cache frequently accessed data
public function get_price_list() {
    $cache_key = 'price_list_all';
    $price_list = $this->cache->get($cache_key);
  
    if (!$price_list) {
        $price_list = $this->db->get('price_list')->result();
        $this->cache->save($cache_key, $price_list, 3600); // 1 hour
    }
  
    return $price_list;
}
```

## 🧪 Testing Guidelines

### Unit Testing Structure

```php
// ✅ Good - Test structure for models
class Order_model_test extends TestCase {
    public function setUp() {
        $this->CI =& get_instance();
        $this->CI->load->model('order_model');
    }
  
    public function test_create_order_with_valid_data() {
        $order_data = [
            'customer_id' => 1,
            'order_date' => date('Y-m-d'),
            'total_paid' => 100.00
        ];
      
        $result = $this->CI->order_model->create_order($order_data);
        $this->assertNotFalse($result);
        $this->assertIsNumeric($result);
    }
  
    public function test_create_order_with_invalid_customer() {
        $order_data = [
            'customer_id' => 'invalid',
            'order_date' => date('Y-m-d'),
            'total_paid' => 100.00
        ];
      
        $result = $this->CI->order_model->create_order($order_data);
        $this->assertFalse($result);
    }
}
```

## 📝 Documentation Standards

### Code Documentation

```php
/**
 * Process customer order and generate invoice
 *
 * @param array $order_data Order information including customer_id, items, and pricing
 * @param bool $send_notification Whether to send email/SMS notification
 * @return array Result array with success status and order details
 * @throws InvalidArgumentException When order data is invalid
 * @since 1.0.0
 */
public function process_order($order_data, $send_notification = true) {
    // Implementation
}
```

### API Documentation

```php
/**
 * API Endpoint: Get customer orders
 * 
 * @api {GET} /flutter/customer_orders Get customer orders
 * @apiVersion 1.0.0
 * @apiName GetCustomerOrders
 * @apiGroup Customer
 * 
 * @apiParam {Number} customer_id Customer's unique ID
 * @apiParam {String} [status] Filter by order status
 * 
 * @apiSuccess {Boolean} success Request success status
 * @apiSuccess {String} message Response message
 * @apiSuccess {Object[]} data List of orders
 * @apiSuccess {Number} data.order_id Order ID
 * @apiSuccess {String} data.invoice_no Invoice number
 * @apiSuccess {String} data.order_status Current status
 * 
 * @apiError {Boolean} success false
 * @apiError {String} message Error description
 */
```

## 🔄 Git Workflow

### Commit Message Format

```
feat: add barcode generation for orders
fix: resolve payment processing issue
docs: update API documentation
style: format customer controller code
refactor: optimize database queries in order model
test: add unit tests for payment processing
```

### Branch Naming

- `feature/order-tracking-system`
- `bugfix/payment-gateway-error`
- `hotfix/security-vulnerability`
- `docs/api-documentation`

## 🚦 Code Review Checklist

### Before Submitting

- [ ] Code follows PSR standards
- [ ] All user inputs are validated and sanitized
- [ ] Database queries use Active Record or prepared statements
- [ ] Error handling is implemented
- [ ] Comments and documentation are added
- [ ] No hardcoded values (use config files)
- [ ] Security best practices are followed
- [ ] Performance implications are considered

### Review Points

- [ ] Code is readable and maintainable
- [ ] Business logic is in appropriate layer (Model/Controller)
- [ ] Database schema changes are documented
- [ ] API responses follow standard format
- [ ] Mobile compatibility is maintained
- [ ] Multi-language support is preserved

---

## 📞 Support

For questions about these rules or coding standards:

- Create an issue with label `coding-standards`
- Reference this document in pull request descriptions
- Follow the established patterns in existing codebase

**Remember**: These rules ensure consistency, maintainability, and security across the entire laundry management system. Always prioritize code quality over quick fixes.

*Last updated: September 2025*
